<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="WebARを利用して、マーカーを読み取ると動画が再生されるAR体験ができます。スマホカメラで手軽に体験が可能です。">


    <title>WebAR動画 | TOP</title>

    <!-- CSS -->
    <link rel="stylesheet" href="./css/style.css" />

    <!-- PWA -->
    <link rel="manifest" href="./manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="WebAR">
    <link rel="apple-touch-icon" href="./assets/images/icon-192.png">

    <!-- 事前ロード -->
    <!-- 高優先度 -->
    <link rel="preload" as="fetch" href="./assets/markers/marker-ptn01.patt" crossorigin="anonymous">
    <link rel="preload" as="fetch" href="./assets/markers/marker-ptn02.patt" crossorigin="anonymous">
    <link rel="preload" as="fetch" href="./assets/markers/marker-ptn03.patt" crossorigin="anonymous">
    
    <!-- 遅延動画 -->
    <link rel="prefetch" as="video" href="./assets/videos/video-01.mp4" type="video/mp4">
    <link rel="prefetch" as="video" href="./assets/videos/video-02.mp4" type="video/mp4">
    <link rel="prefetch" as="video" href="./assets/videos/video-03.mp4" type="video/mp4">


    <!-- ライブラリ -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <!-- JavaScript -->
    <script src="./js/core/loadingManager.js" defer></script>
    <script src="./js/core/statusDisplay.js" defer></script>
    <script src="./js/video/videoPlayer.js" defer></script>
    <script src="./js/video/videoPlane.js" defer></script>
    <script src="./js/ar/arMarker.js" defer></script>
    <script src="./js/ar/arSceneManager.js" defer></script>

    <!-- ファビコン -->
    <link rel="icon" href="./favicon.ico" type="image/x-icon" />
</head>
<body>
    <header class="fixed-header">
        <div class="header-content">
            <div class="header-logo">
                <a href="./index.html">WebAR</a>
            </div>
            <nav class="header-nav">
                <ul>
                    <li><a href="./pages/guide.html">使い方</a></li>
                    <li><a href="./pages/benefit.html">特典</a></li>
                    <li><a href="./pages/information.html">動作環境</a></li>
                </ul>
            </nav>
        </div>
        <div class="header-debug">
            <p id="status-text">ステータス: 待機中</p>
        </div>
    </header>

    <main>
        <div id="interaction-overlay">
            <div class="interaction-prompt">
                <p>カメラへのアクセスとAR体験を開始するには、<br/>
                    "AR体験を開始" をタップ！<br>
                    <br>【利用方法】<br>
                    1. マーカーから15-30cm 離してカメラを向ける<br>
                    2. マーカーが認識されると動画が再生されます<br>
                    3. 再生できない時は、「特典」ページを見てね<br>
                    <br><small>※カメラ権限の許可が求められた場合は「許可」を選択してください</small>
                </p>
                <button id="start-ar-btn">AR体験を開始</button>
            </div>
        </div>

        <div id="loading">
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill"></div>
                </div>
                <div id="loading-percentage">Loading: 0%</div>
                <div class="loading-status">ARカメラを初期化中...</div>
            </div>
        </div>
    </main>

    <a-scene
        id="ar-scene"
        embedded
        arjs="
        sourceType: webcam;
        debugUIEnabled: false;
        detectionMode: mono_and_matrix;
        matrixCodeType: 3x3;
        patternRatio: 0.8;
        maxDetectionRate: 60;
        trackingMethod: best;
        sourceWidth: 640;
        sourceHeight: 480;
        displayWidth: 640;
        displayHeight: 480;"
        style="width: 100vw; height: 100vh; overflow: hidden; display: none; position: fixed; top: 0; left: 0;"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false"
        gesture-detector
        raycaster="objects: .clickable"
    >
        <a-assets>
            <video id="video-01" 
                src="./assets/videos/video-01.mp4" 
                loop 
                muted 
                playsinline 
                preload="none"
                crossorigin="anonymous"
                webkit-playsinline="true"></video>
            <video id="video-02" 
                src="./assets/videos/video-02.mp4" 
                loop 
                muted 
                playsinline 
                preload="none"
                crossorigin="anonymous"
                webkit-playsinline="true"></video>
            <video id="video-03" 
                src="./assets/videos/video-03.mp4" 
                loop 
                muted 
                playsinline 
                preload="none"
                crossorigin="anonymous"
                webkit-playsinline="true"></video>
        </a-assets>

        <a-marker type="pattern" url="./assets/markers/marker-ptn01.patt" id="marker-01" 
                patternRatio="0.8" 
                smooth="true" 
                smoothCount="10" 
                smoothTolerance="0.05" 
                smoothThreshold="5"
                raycaster="objects: .clickable">
            <a-plane id="plane-01" 
                        position="0 0 0.01" 
                        rotation="-90 0 0" 
                        width="1.8" 
                        height="1.0125"
                        material="src: #video-01; shader: flat; transparent: true; opacity: 0"
                        visible="false"></a-plane>
        </a-marker>

        <a-marker type="pattern" url="./assets/markers/marker-ptn02.patt" id="marker-02" 
                patternRatio="0.8" 
                smooth="true" 
                smoothCount="10" 
                smoothTolerance="0.05" 
                smoothThreshold="5"
                raycaster="objects: .clickable">
            <a-plane id="plane-02" 
                        position="0 0 0.01" 
                        rotation="-90 0 0" 
                        width="1.8" 
                        height="1.0125"
                        material="src: #video-02; shader: flat; transparent: true; opacity: 0"
                        visible="false"></a-plane>
        </a-marker>

        <a-marker type="pattern" url="./assets/markers/marker-ptn03.patt" id="marker-03" 
                patternRatio="0.8" 
                smooth="true" 
                smoothCount="10" 
                smoothTolerance="0.05" 
                smoothThreshold="5"
                raycaster="objects: .clickable">
            <a-plane id="plane-03" 
                        position="0 0 0.01" 
                        rotation="-90 0 0" 
                        width="1.8" 
                        height="1.0125"
                        material="src: #video-03; shader: flat; transparent: true; opacity: 0"
                        visible="false"></a-plane>
        </a-marker>

        <a-entity camera></a-entity>
    </a-scene>

    <script>
        // Android Chrome/Edge検出とbodyクラス追加
        document.addEventListener("DOMContentLoaded", () => {
            const userAgent = navigator.userAgent;
            if (/Android.*Chrome/i.test(userAgent)) {
                document.body.classList.add('android-chrome');
                console.log("Detected Android Chrome");
            } else if (/Android.*Edge/i.test(userAgent)) {
                document.body.classList.add('android-edge');
                console.log("Detected Android Edge");
            }
        });
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            console.log("DOM loaded, initializing AR scene...");
            
            const sceneManager = new ARSceneManager({
                loadingSelector: "#loading",
                statusSelector: "#status-text",
                interactionOverlaySelector: "#interaction-overlay"
            });

            // グローバルアクセス用（デバッグ目的）
            window.arSceneManager = sceneManager;

            // ユーザーインタラクションでAR開始
            const startBtn = document.getElementById("start-ar-btn");
            startBtn.addEventListener("click", async () => {
                console.log("Start AR button clicked");
                try {
                    await sceneManager.startAR();
                } catch (error) {
                    console.error("Failed to start AR:", error);
                }
            });

            // A-Frameシーンのエラーハンドリング
            const arScene = document.getElementById("ar-scene");
            arScene.addEventListener("enter-vr", () => {
                console.log("AR scene entered");
            });

            arScene.addEventListener("exit-vr", () => {
                console.log("AR scene exited");
            });

            // デバッグ用キーボードショートカット（デスクトップのみ）
            document.addEventListener("keydown", (event) => {
                if (!sceneManager.isARReady) return;
                
            switch(event.key) {
                case 'd': // デバッグ情報表示
                    sceneManager.debugMarkerPositions();
                    break;
                case 'r': // 位置リセット
                    console.log("Position reset disabled in single marker mode");
                    break;
                case 'c': // 現在のアクティブマーカー表示
                    console.log("Current active marker:", sceneManager.currentActiveMarker);
                    break;
                case 's': // 単一表示モードの状態確認
                    console.log("Single marker mode status:", {
                        maxSimultaneous: sceneManager.maxSimultaneousMarkers,
                        currentActive: sceneManager.currentActiveMarker,
                        conflictDetection: sceneManager.conflictDetectionEnabled
                    });
                    break;
                case 't': // 🆕 マーカー検出テスト
                    console.log("Testing marker detection...");
                    sceneManager.checkMarkerStatus();
                    break;
                case 'm': // 🆕 手動マーカーアクティベーション（テスト用）
                    console.log("Manual marker activation test");
                    const testMarker = sceneManager.instances[0];
                    if (testMarker) {
                        testMarker.arMarker.activateMarker();
                    }
                    break;
                    // case '1': // マーカー01の位置調整（無効化）
                    // case '2': // マーカー02の位置調整（無効化）
                    // case '3': // マーカー03の位置調整（無効化）
                }
            });

            console.log("Event listeners attached with single marker debug controls");
            console.log("Debug keys: d=debug info, c=current marker, s=single mode status");
        });
    </script>

    <!-- キャッシュ登録: トップ画面・ガイド・動画ファイル -->
    <script>
    if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./js/core/serviceWorker.js')
        .then(() => console.log("Service Worker registered"))
        .catch(err => console.error("SW registration failed:", err));
    }
    </script>

    <!-- Google向けSEO: JSON-LD構造化データ -->
    <script type="application/ld+json">
    {
    "@context": "https://schema.org",
    "@type": "SoftwareApplication",
    "name": "WebAR Video Experience",
    "operatingSystem": "Android, iOS",
    "applicationCategory": "AugmentedRealityApplication",
    "description": "マーカーを読み取ると動画が再生されるWebAR体験アプリ",
    "url": "https://example.com/"
    }
    </script>
</body>
</html>